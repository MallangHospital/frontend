<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>의료진 정보 수정</title>

  <link rel="stylesheet" href="common_assets/globalstyle.css">
  <link rel="stylesheet" href="common_assets/navbar_admin.css">   <!--네비게이션 바 css-->
  <link rel="stylesheet" href="common_assets/footer.css">   <!--푸터 css-->

  <!-- 폰트 연결-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet"> 

  <!--제이쿼리 연결-->
  <script src="common_assets/jquery-3.7.1.min.js"></script>
  <script defer src="common_assets/script_admin.js"></script>
  <style>
    /* 팝업 스타일 */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .popup-content {
      background: #DFD9D9;
      padding: 70px 120px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .popup-content p {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .popup-content button {
      padding: 10px 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
    }

    .popup-content button:hover {
      background: #f5f5f5;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="navbar"></div> <!-- 네비게이션 바 -->

    <!-- 의료진 정보 수정 -->
    <section style="margin: 50px auto; max-width: 600px;">
      <h2 style="font-weight: bold; font-size: 18px; margin-bottom: 30px;">의료진 정보 수정</h2>
      <form id="doctor-update-form">
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="doctor-name" style="font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block;">이름:</label>
          <input type="text" id="doctor-name" name="name" placeholder="의료진 이름" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="doctor-specialty" style="font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block;">전문 분야:</label>
          <select id="doctor-specialty" name="specialty" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="" disabled selected>전문 분야를 선택하세요</option>
            <option value="내과">내과</option>
            <option value="산부인과">산부인과</option>
            <option value="소아청소년과">소아청소년과</option>
            <option value="외과">외과</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="doctor-contact" style="font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block;">연락처:</label>
          <input type="text" id="doctor-contact" name="contact" placeholder="연락처" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="doctor-image-preview" style="font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block;">의료진 사진:</label>
          <img id="doctor-image-preview" src="" alt="현재 이미지 미리보기" style="width: 100px; height: auto; display: block; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;"></div>
          <input type="file" id="doctor-image" name="photo" accept="image/*" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        
      
        <button type="submit" class="btn-submit" 
        style="background-color: #A6B1BB; 
               color: white; 
               margin: 20px auto 100px auto; /* 아래에 40px 마진 추가 */
               padding: 10px 20px; 
               border: none; 
               border-radius: 4px; 
               cursor: pointer; 
               width: 30%; 
               display: block;">
    수정하기
</button>

      </form>
    </section>

    <!-- 팝업창 -->
    <div id="popup-overlay" class="popup-overlay">
      <div class="popup-content">
        <p>수정되었습니다.</p>
        <button id="close-popup">확인</button>
      </div>
    </div>

    <div id="footer"></div> <!-- 푸터 -->
  </div>

  <script>
document.addEventListener("DOMContentLoaded", async () => {
    const baseUrl = "https://mallang-a85bb2ff492b.herokuapp.com";
    const doctorId = new URLSearchParams(window.location.search).get("doctorId");

    if (!doctorId) {
        alert("유효한 의사 ID가 아닙니다.");
        window.location.href = "doctor_management.html"; // 목록 페이지로 리다이렉트
        return;
    }

    console.log(`수정 페이지 로드: doctorId=${doctorId}`);

    async function loadDoctorInfo() {
        try {
            const response = await fetch(`${baseUrl}/api/doctors/${doctorId}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
            });

            if (response.ok) {
                const doctor = await response.json();
                console.log("의사 정보 로드 성공:", doctor);
                populateForm(doctor);
            } else {
                console.error("의사 정보 로드 실패:", response.status);
                alert("의사 정보를 불러오는 데 실패했습니다.");
                window.location.href = "doctor_management.html";
            }
        } catch (error) {
            console.error("네트워크 오류:", error);
            alert("의사 정보를 불러오는 중 오류가 발생했습니다.");
        }
    }

    function populateForm(doctor) {
        document.getElementById("doctor-name").value = doctor.name || "";
        document.getElementById("doctor-specialty").value = doctor.departmentName || "";
        document.getElementById("doctor-contact").value = doctor.phoneNumber || "";

        // 사진 미리보기 설정
        if (doctor.photoUrl) {
            const preview = document.createElement("img");
            preview.id = "doctor-image-preview";
            preview.src = doctor.photoUrl;
            preview.alt = "의료진 사진";
            preview.style = "width: 100px; height: 100px; margin-top: 10px;";
            document.getElementById("doctor-image").parentElement.appendChild(preview);
        }
    }

    await loadDoctorInfo();

    document.getElementById("doctor-update-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document.getElementById("doctor-name").value.trim();
        const departmentName = document.getElementById("doctor-specialty").value.trim();
        const contact = document.getElementById("doctor-contact").value.trim();
        const photoInput = document.getElementById("doctor-image");
        const photoFile = photoInput.files[0];

        if (!name || !departmentName || !contact) {
            alert("모든 필드를 입력해주세요.");
            return;
        }

        let photoUrl = null;

        // 사진 파일 업로드 처리
        if (photoFile) {
            const formData = new FormData();
            formData.append("file", photoFile);

            try {
                const uploadResponse = await fetch(`${baseUrl}/api/uploads`, {
                    method: "POST",
                    body: formData,
                });

                if (uploadResponse.ok) {
                    const uploadResult = await uploadResponse.json();
                    photoUrl = uploadResult.url; // 서버에서 반환된 업로드된 파일 URL
                    console.log("사진 업로드 성공:", photoUrl);
                } else {
                    console.error("사진 업로드 실패:", uploadResponse.status);
                    alert("사진 업로드에 실패했습니다.");
                    return;
                }
            } catch (uploadError) {
                console.error("사진 업로드 중 오류 발생:", uploadError);
                alert("사진 업로드 중 문제가 발생했습니다.");
                return;
            }
        }

        const updatedData = {
            name,
            departmentName,
            phoneNumber: contact,
            photoUrl: photoUrl || document.getElementById("doctor-image-preview")?.src, // 기존 사진 URL 사용
        };

        console.log("서버로 전송할 데이터:", updatedData); // 서버로 전송할 데이터 로그

        try {
            const response = await fetch(`${baseUrl}/api/doctors/${doctorId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(updatedData),
            });

            if (response.ok) {
                console.log("의사 정보 수정 성공");
                alert("의사 정보가 성공적으로 수정되었습니다.");
                window.location.href = "doctor_management_admin.html";
            } else {
                const errorText = await response.text();
                console.error("의사 정보 수정 실패:", response.status, errorText);
                alert(`의사 정보 수정에 실패했습니다. 상태 코드: ${response.status}\n응답 내용: ${errorText}`);
            }
        } catch (error) {
            console.error("수정 요청 중 오류 발생:", error);
            alert("수정 요청 중 문제가 발생했습니다.");
        }
    });
});

  </script>
</body>
</html>
